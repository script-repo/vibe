<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG-Powered Knowledge Base</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-1: #667eea;
            --accent-2: #764ba2;
            --accent-3: #f093fb;
            --accent-4: #4facfe;
            --border-color: #dee2e6;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --shadow: rgba(0, 0, 0, 0.1);
            --highlight: rgba(102, 126, 234, 0.2);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #eee;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --shadow: rgba(0, 0, 0, 0.3);
            --highlight: rgba(102, 126, 234, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--accent-1) 0%, var(--accent-2) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px var(--shadow);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            color: var(--accent-1);
            border-bottom-color: var(--accent-1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--accent-1);
            background: var(--bg-tertiary);
        }

        .upload-section.dragging {
            border-color: var(--accent-1);
            background: var(--highlight);
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            resize: vertical;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .document-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .document-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .document-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
            border-color: var(--accent-1);
        }

        .document-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent-1);
        }

        .document-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .document-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .document-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .qa-section {
            margin-top: 20px;
        }

        .question-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .question-input input {
            flex: 1;
            margin-bottom: 0;
        }

        .answer-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .answer-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .sources {
            margin-top: 15px;
        }

        .source-title {
            font-weight: 600;
            color: var(--accent-1);
            margin-bottom: 10px;
        }

        .source-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .source-item:hover {
            background: var(--highlight);
        }

        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .source-doc {
            font-weight: 600;
            color: var(--accent-2);
        }

        .source-score {
            background: var(--accent-1);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .source-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .highlighted {
            background: var(--highlight);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--accent-3), var(--accent-4));
            border-radius: 15px;
            padding: 20px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-results {
            margin-top: 20px;
        }

        .result-item {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-title {
            font-weight: 600;
            color: var(--accent-1);
        }

        .result-relevance {
            background: var(--accent-2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .result-snippet {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        #knowledge-graph {
            width: 100%;
            height: 500px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            position: relative;
        }

        .graph-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }

        .graph-controls .btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--danger);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--accent-1);
        }

        .chunk-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chunk-item {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-1);
            padding: 15px;
            border-radius: 8px;
        }

        .chunk-header {
            font-weight: 600;
            color: var(--accent-2);
            margin-bottom: 8px;
        }

        .chunk-text {
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.2rem;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-item {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
        }

        .history-question {
            font-weight: 600;
            color: var(--accent-1);
            margin-bottom: 8px;
        }

        .history-answer {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .history-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
            opacity: 0.7;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-info {
            background: var(--accent-4);
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .document-list {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .theme-toggle {
                position: static;
                margin-bottom: 15px;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
            <h1>RAG Knowledge Base</h1>
            <p class="subtitle">Retrieval-Augmented Generation with Intelligent Search</p>
        </header>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="doc-count">0</div>
                <div class="stat-label">Documents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="chunk-count">0</div>
                <div class="stat-label">Chunks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="query-count">0</div>
                <div class="stat-label">Queries</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="kb-size">0 KB</div>
                <div class="stat-label">Total Size</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload', this)">üì§ Upload</button>
            <button class="tab" onclick="switchTab('query', this)">‚ùì Ask Questions</button>
            <button class="tab" onclick="switchTab('documents', this)">üìö Documents</button>
            <button class="tab" onclick="switchTab('search', this)">üîç Search</button>
            <button class="tab" onclick="switchTab('graph', this)">üï∏Ô∏è Knowledge Graph</button>
            <button class="tab" onclick="switchTab('history', this)">üìú History</button>
        </div>

        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content active">
            <div class="upload-section" id="drop-zone">
                <p style="font-size: 2rem; margin-bottom: 10px;">üìÑ</p>
                <p style="font-size: 1.2rem; margin-bottom: 10px;">Drop text files here or click to upload</p>
                <input type="file" id="file-input" accept=".txt,.md,.json" multiple style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                    Choose Files
                </button>
            </div>

            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">Or Paste Text Content</h3>
                <input type="text" id="doc-title" placeholder="Document Title">
                <textarea id="text-content" placeholder="Paste your text content here..."></textarea>
                <div class="controls" style="justify-content: flex-start; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="addDocument()">Add Document</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear</button>
                </div>
            </div>
        </div>

        <!-- Query Tab -->
        <div id="query-tab" class="tab-content">
            <div class="qa-section">
                <div class="question-input">
                    <input type="text" id="question" placeholder="Ask a question about your knowledge base..." onkeypress="if(event.key==='Enter') askQuestion()">
                    <button class="btn btn-primary" onclick="askQuestion()">
                        <span id="ask-btn-text">Ask</span>
                    </button>
                </div>

                <div id="answer-container"></div>
            </div>
        </div>

        <!-- Documents Tab -->
        <div id="documents-tab" class="tab-content">
            <div class="controls">
                <button class="btn btn-success" onclick="exportKnowledgeBase()">üíæ Export Knowledge Base</button>
                <button class="btn btn-danger" onclick="clearAllDocuments()">üóëÔ∏è Clear All</button>
            </div>
            <div class="document-list" id="document-list"></div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="tab-content">
            <div class="search-section">
                <div class="question-input">
                    <input type="text" id="search-query" placeholder="Search across all documents..." onkeypress="if(event.key==='Enter') searchDocuments()">
                    <button class="btn btn-primary" onclick="searchDocuments()">Search</button>
                </div>
            </div>
            <div class="search-results" id="search-results"></div>
        </div>

        <!-- Knowledge Graph Tab -->
        <div id="graph-tab" class="tab-content">
            <canvas id="knowledge-graph"></canvas>
            <div class="graph-controls">
                <button class="btn btn-secondary" onclick="regenerateGraph()">üîÑ Regenerate</button>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content">
            <div class="controls">
                <button class="btn btn-danger" onclick="clearHistory()">Clear History</button>
            </div>
            <div class="history-list" id="history-list"></div>
        </div>
    </div>

    <!-- Document View Modal -->
    <div id="document-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">‚úï</button>
            <h2 class="modal-title" id="modal-doc-title"></h2>
            <div id="modal-doc-content"></div>
        </div>
    </div>

    <script>
        // RAG Knowledge Base Engine
        class RAGKnowledgeBase {
            constructor() {
                this.documents = [];
                this.chunks = [];
                this.history = [];
                this.queryCount = 0;
                this.chunkSize = 500; // characters per chunk
                this.chunkOverlap = 100; // overlap between chunks
                this.loadFromStorage();
            }

            // TF-IDF and Vector Operations
            tokenize(text) {
                return text.toLowerCase()
                    .replace(/[^\w\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 2);
            }

            calculateTF(tokens) {
                const tf = {};
                const totalTokens = tokens.length;
                tokens.forEach(token => {
                    tf[token] = (tf[token] || 0) + 1;
                });
                Object.keys(tf).forEach(token => {
                    tf[token] = tf[token] / totalTokens;
                });
                return tf;
            }

            calculateIDF() {
                const idf = {};
                const totalDocs = this.chunks.length;

                // Get all unique terms
                const allTerms = new Set();
                this.chunks.forEach(chunk => {
                    const tokens = this.tokenize(chunk.text);
                    new Set(tokens).forEach(token => allTerms.add(token));
                });

                // Calculate IDF for each term
                allTerms.forEach(term => {
                    const docsWithTerm = this.chunks.filter(chunk =>
                        this.tokenize(chunk.text).includes(term)
                    ).length;
                    idf[term] = Math.log(totalDocs / (docsWithTerm + 1));
                });

                return idf;
            }

            calculateTFIDF(tokens, idf) {
                const tf = this.calculateTF(tokens);
                const tfidf = {};
                Object.keys(tf).forEach(token => {
                    tfidf[token] = tf[token] * (idf[token] || 0);
                });
                return tfidf;
            }

            cosineSimilarity(vec1, vec2) {
                const allKeys = new Set([...Object.keys(vec1), ...Object.keys(vec2)]);
                let dotProduct = 0;
                let mag1 = 0;
                let mag2 = 0;

                allKeys.forEach(key => {
                    const val1 = vec1[key] || 0;
                    const val2 = vec2[key] || 0;
                    dotProduct += val1 * val2;
                    mag1 += val1 * val1;
                    mag2 += val2 * val2;
                });

                if (mag1 === 0 || mag2 === 0) return 0;
                return dotProduct / (Math.sqrt(mag1) * Math.sqrt(mag2));
            }

            // Document Management
            addDocument(title, content) {
                const doc = {
                    id: Date.now(),
                    title: title || `Document ${this.documents.length + 1}`,
                    content: content,
                    addedAt: new Date().toISOString(),
                    size: content.length
                };

                this.documents.push(doc);
                this.chunkDocument(doc);
                this.saveToStorage();
                return doc;
            }

            chunkDocument(doc) {
                const text = doc.content;
                const chunks = [];
                let start = 0;

                while (start < text.length) {
                    let end = Math.min(start + this.chunkSize, text.length);

                    // Try to break at sentence boundaries
                    if (end < text.length) {
                        const sentenceEnd = text.lastIndexOf('.', end);
                        if (sentenceEnd > start + this.chunkSize / 2) {
                            end = sentenceEnd + 1;
                        }
                    }

                    const chunkText = text.slice(start, end).trim();
                    if (chunkText.length > 0) {
                        chunks.push({
                            id: `${doc.id}-${chunks.length}`,
                            documentId: doc.id,
                            documentTitle: doc.title,
                            text: chunkText,
                            index: chunks.length,
                            position: start
                        });
                    }

                    start = end - this.chunkOverlap;
                }

                this.chunks.push(...chunks);
                return chunks;
            }

            deleteDocument(docId) {
                this.documents = this.documents.filter(doc => doc.id !== docId);
                this.chunks = this.chunks.filter(chunk => chunk.documentId !== docId);
                this.saveToStorage();
            }

            // RAG Query Processing
            retrieveRelevantChunks(query, topK = 5) {
                if (this.chunks.length === 0) return [];

                const queryTokens = this.tokenize(query);
                const idf = this.calculateIDF();
                const queryTFIDF = this.calculateTFIDF(queryTokens, idf);

                // Calculate similarity for each chunk
                const similarities = this.chunks.map(chunk => {
                    const chunkTokens = this.tokenize(chunk.text);
                    const chunkTFIDF = this.calculateTFIDF(chunkTokens, idf);
                    const similarity = this.cosineSimilarity(queryTFIDF, chunkTFIDF);

                    return {
                        chunk,
                        similarity,
                        keywords: this.extractKeywords(chunk.text, queryTokens)
                    };
                });

                // Sort by similarity and return top K
                return similarities
                    .sort((a, b) => b.similarity - a.similarity)
                    .slice(0, topK)
                    .filter(item => item.similarity > 0);
            }

            extractKeywords(text, queryTokens) {
                const tokens = this.tokenize(text);
                const keywords = tokens.filter(token => queryTokens.includes(token));
                return [...new Set(keywords)];
            }

            generateAnswer(query, relevantChunks) {
                if (relevantChunks.length === 0) {
                    return {
                        answer: "I couldn't find any relevant information in the knowledge base to answer this question.",
                        sources: []
                    };
                }

                // Extract key information from relevant chunks
                const queryTokens = this.tokenize(query);
                let answer = "";

                // Identify the most relevant sentences
                const sentences = [];
                relevantChunks.forEach(item => {
                    const chunkSentences = item.chunk.text.split(/[.!?]+/).filter(s => s.trim());
                    chunkSentences.forEach(sentence => {
                        const sentenceTokens = this.tokenize(sentence);
                        const relevance = queryTokens.filter(qt => sentenceTokens.includes(qt)).length;
                        if (relevance > 0) {
                            sentences.push({
                                text: sentence.trim(),
                                relevance,
                                chunk: item.chunk
                            });
                        }
                    });
                });

                // Sort sentences by relevance and take top ones
                sentences.sort((a, b) => b.relevance - a.relevance);
                const topSentences = sentences.slice(0, 3);

                if (topSentences.length > 0) {
                    answer = topSentences.map(s => s.text).join('. ');
                    if (!answer.endsWith('.')) answer += '.';
                } else {
                    // Fallback: use the most relevant chunk's beginning
                    const topChunk = relevantChunks[0].chunk;
                    answer = topChunk.text.slice(0, 300) + '...';
                }

                // Prepare sources with highlighting
                const sources = relevantChunks.map(item => ({
                    chunk: item.chunk,
                    similarity: item.similarity,
                    keywords: item.keywords,
                    highlightedText: this.highlightKeywords(item.chunk.text, queryTokens)
                }));

                return { answer, sources };
            }

            highlightKeywords(text, keywords) {
                let highlightedText = text;
                keywords.forEach(keyword => {
                    const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                    highlightedText = highlightedText.replace(regex,
                        match => `<span class="highlighted">${match}</span>`
                    );
                });
                return highlightedText;
            }

            askQuestion(query) {
                this.queryCount++;
                const relevantChunks = this.retrieveRelevantChunks(query);
                const result = this.generateAnswer(query, relevantChunks);

                // Add to history
                this.history.unshift({
                    question: query,
                    answer: result.answer,
                    sourceCount: result.sources.length,
                    timestamp: new Date().toISOString()
                });

                // Keep only last 50 queries
                if (this.history.length > 50) {
                    this.history = this.history.slice(0, 50);
                }

                this.saveToStorage();
                return result;
            }

            // Search functionality
            searchDocuments(query, limit = 20) {
                const results = this.retrieveRelevantChunks(query, limit);
                return results.map(item => ({
                    document: this.documents.find(doc => doc.id === item.chunk.documentId),
                    chunk: item.chunk,
                    similarity: item.similarity,
                    highlightedText: this.highlightKeywords(item.chunk.text, this.tokenize(query))
                }));
            }

            // Knowledge Graph
            buildKnowledgeGraph() {
                const graph = {
                    nodes: [],
                    edges: []
                };

                // Create nodes for documents
                this.documents.forEach(doc => {
                    const keywords = this.extractTopKeywords(doc.content, 5);
                    graph.nodes.push({
                        id: doc.id,
                        label: doc.title,
                        type: 'document',
                        keywords
                    });
                });

                // Create edges based on shared keywords
                for (let i = 0; i < graph.nodes.length; i++) {
                    for (let j = i + 1; j < graph.nodes.length; j++) {
                        const node1 = graph.nodes[i];
                        const node2 = graph.nodes[j];
                        const sharedKeywords = node1.keywords.filter(k =>
                            node2.keywords.includes(k)
                        );

                        if (sharedKeywords.length > 0) {
                            graph.edges.push({
                                from: node1.id,
                                to: node2.id,
                                weight: sharedKeywords.length,
                                keywords: sharedKeywords
                            });
                        }
                    }
                }

                return graph;
            }

            extractTopKeywords(text, count = 5) {
                const tokens = this.tokenize(text);
                const freq = {};
                tokens.forEach(token => {
                    freq[token] = (freq[token] || 0) + 1;
                });

                // Remove common stop words
                const stopWords = new Set(['the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'has', 'was', 'were', 'been', 'have', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'this', 'that', 'with', 'from']);
                Object.keys(freq).forEach(word => {
                    if (stopWords.has(word)) {
                        delete freq[word];
                    }
                });

                return Object.entries(freq)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, count)
                    .map(([word]) => word);
            }

            // Storage
            saveToStorage() {
                localStorage.setItem('rag_documents', JSON.stringify(this.documents));
                localStorage.setItem('rag_chunks', JSON.stringify(this.chunks));
                localStorage.setItem('rag_history', JSON.stringify(this.history));
                localStorage.setItem('rag_query_count', this.queryCount.toString());
            }

            loadFromStorage() {
                try {
                    const docs = localStorage.getItem('rag_documents');
                    const chunks = localStorage.getItem('rag_chunks');
                    const history = localStorage.getItem('rag_history');
                    const count = localStorage.getItem('rag_query_count');

                    if (docs) this.documents = JSON.parse(docs);
                    if (chunks) this.chunks = JSON.parse(chunks);
                    if (history) this.history = JSON.parse(history);
                    if (count) this.queryCount = parseInt(count);
                } catch (e) {
                    console.error('Error loading from storage:', e);
                }
            }

            getTotalSize() {
                return this.documents.reduce((sum, doc) => sum + doc.size, 0);
            }

            exportData() {
                return {
                    documents: this.documents,
                    chunks: this.chunks,
                    history: this.history,
                    exportedAt: new Date().toISOString()
                };
            }

            clearAll() {
                this.documents = [];
                this.chunks = [];
                this.saveToStorage();
            }

            clearHistory() {
                this.history = [];
                this.saveToStorage();
            }
        }

        // Initialize RAG system
        const rag = new RAGKnowledgeBase();

        // UI Functions
        function updateStats() {
            document.getElementById('doc-count').textContent = rag.documents.length;
            document.getElementById('chunk-count').textContent = rag.chunks.length;
            document.getElementById('query-count').textContent = rag.queryCount;
            const size = (rag.getTotalSize() / 1024).toFixed(1);
            document.getElementById('kb-size').textContent = `${size} KB`;
        }

        function switchTab(tabName, tabButton) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (tabButton) {
                tabButton.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Refresh content if needed
            if (tabName === 'documents') {
                renderDocuments();
            } else if (tabName === 'graph') {
                renderKnowledgeGraph();
            } else if (tabName === 'history') {
                renderHistory();
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Redraw graph if visible
            if (document.getElementById('graph-tab').classList.contains('active')) {
                renderKnowledgeGraph();
            }
        }

        // File upload handling
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragging');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragging');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragging');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    rag.addDocument(file.name, content);
                    updateStats();
                    renderDocuments();
                    alert(`Document "${file.name}" added successfully!`);
                };
                reader.readAsText(file);
            });
            fileInput.value = '';
        }

        function addDocument() {
            const title = document.getElementById('doc-title').value.trim();
            const content = document.getElementById('text-content').value.trim();

            if (!content) {
                alert('Please enter some content');
                return;
            }

            rag.addDocument(title, content);
            updateStats();
            renderDocuments();
            clearForm();
            alert('Document added successfully!');
        }

        function clearForm() {
            document.getElementById('doc-title').value = '';
            document.getElementById('text-content').value = '';
        }

        function renderDocuments() {
            const container = document.getElementById('document-list');

            if (rag.documents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <div class="empty-state-text">No documents yet. Upload or paste some content to get started!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = rag.documents.map(doc => {
                const chunks = rag.chunks.filter(c => c.documentId === doc.id);
                return `
                    <div class="document-card">
                        <div class="document-title">${doc.title}</div>
                        <div class="document-meta">
                            ${(doc.size / 1024).toFixed(2)} KB ‚Ä¢ ${chunks.length} chunks
                        </div>
                        <div class="document-meta">
                            Added: ${new Date(doc.addedAt).toLocaleString()}
                        </div>
                        <div class="document-actions">
                            <button class="btn btn-secondary" onclick="viewDocument(${doc.id})">
                                üëÅÔ∏è View
                            </button>
                            <button class="btn btn-danger" onclick="deleteDocument(${doc.id})">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewDocument(docId) {
            const doc = rag.documents.find(d => d.id === docId);
            const chunks = rag.chunks.filter(c => c.documentId === docId);

            document.getElementById('modal-doc-title').textContent = doc.title;
            document.getElementById('modal-doc-content').innerHTML = `
                <div style="margin-bottom: 20px; color: var(--text-secondary);">
                    <strong>Size:</strong> ${(doc.size / 1024).toFixed(2)} KB<br>
                    <strong>Chunks:</strong> ${chunks.length}<br>
                    <strong>Added:</strong> ${new Date(doc.addedAt).toLocaleString()}
                </div>
                <h3 style="margin-bottom: 15px;">Content Chunks</h3>
                <div class="chunk-list">
                    ${chunks.map(chunk => `
                        <div class="chunk-item">
                            <div class="chunk-header">Chunk ${chunk.index + 1}</div>
                            <div class="chunk-text">${chunk.text}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('document-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('document-modal').classList.remove('active');
        }

        function deleteDocument(docId) {
            if (confirm('Are you sure you want to delete this document?')) {
                rag.deleteDocument(docId);
                updateStats();
                renderDocuments();
            }
        }

        function askQuestion() {
            const question = document.getElementById('question').value.trim();
            if (!question) {
                alert('Please enter a question');
                return;
            }

            if (rag.documents.length === 0) {
                alert('Please add some documents first');
                return;
            }

            const btn = document.getElementById('ask-btn-text');
            btn.innerHTML = '<div class="spinner"></div>';

            setTimeout(() => {
                const result = rag.askQuestion(question);
                displayAnswer(question, result);
                btn.textContent = 'Ask';
                document.getElementById('question').value = '';
                updateStats();
            }, 500);
        }

        function displayAnswer(question, result) {
            const container = document.getElementById('answer-container');

            const sourcesHTML = result.sources.length > 0 ? `
                <div class="sources">
                    <div class="source-title">üìé Sources (${result.sources.length})</div>
                    ${result.sources.map((source, idx) => `
                        <div class="source-item">
                            <div class="source-header">
                                <div class="source-doc">${source.chunk.documentTitle}</div>
                                <div class="source-score">${(source.similarity * 100).toFixed(1)}% match</div>
                            </div>
                            <div class="source-text">${source.highlightedText}</div>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            container.innerHTML = `
                <div class="answer-box">
                    <div style="color: var(--accent-2); font-weight: 600; margin-bottom: 10px;">
                        ‚ùì ${question}
                    </div>
                    <div class="answer-text">${result.answer}</div>
                    ${sourcesHTML}
                </div>
            `;
        }

        function searchDocuments() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            const results = rag.searchDocuments(query);
            const container = document.getElementById('search-results');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">No results found for "${query}"</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <h3 style="margin-bottom: 15px;">Found ${results.length} results</h3>
                ${results.map(result => `
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-title">${result.document.title}</div>
                            <div class="result-relevance">${(result.similarity * 100).toFixed(1)}% relevant</div>
                        </div>
                        <div class="result-snippet">${result.highlightedText}</div>
                    </div>
                `).join('')}
            `;
        }

        function renderKnowledgeGraph() {
            const canvas = document.getElementById('knowledge-graph');
            const ctx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const graph = rag.buildKnowledgeGraph();

            if (graph.nodes.length === 0) {
                ctx.fillStyle = getComputedStyle(document.documentElement)
                    .getPropertyValue('--text-secondary');
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No documents to visualize', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Position nodes in a circle
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.35;

            graph.nodes.forEach((node, idx) => {
                const angle = (idx / graph.nodes.length) * Math.PI * 2;
                node.x = centerX + radius * Math.cos(angle);
                node.y = centerY + radius * Math.sin(angle);
            });

            // Get theme colors
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const nodeColor = isDark ? '#667eea' : '#764ba2';
            const edgeColor = isDark ? 'rgba(102, 126, 234, 0.3)' : 'rgba(118, 75, 162, 0.3)';
            const textColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--text-primary');

            // Draw edges
            ctx.strokeStyle = edgeColor;
            graph.edges.forEach(edge => {
                const from = graph.nodes.find(n => n.id === edge.from);
                const to = graph.nodes.find(n => n.id === edge.to);

                ctx.lineWidth = edge.weight * 2;
                ctx.beginPath();
                ctx.moveTo(from.x, from.y);
                ctx.lineTo(to.x, to.y);
                ctx.stroke();
            });

            // Draw nodes
            graph.nodes.forEach(node => {
                // Node circle
                ctx.fillStyle = nodeColor;
                ctx.beginPath();
                ctx.arc(node.x, node.y, 30, 0, Math.PI * 2);
                ctx.fill();

                // Node label
                ctx.fillStyle = textColor;
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(node.label.slice(0, 15), node.x, node.y - 40);

                // Keywords
                ctx.font = '10px Arial';
                ctx.fillStyle = getComputedStyle(document.documentElement)
                    .getPropertyValue('--text-secondary');
                ctx.fillText(node.keywords.slice(0, 3).join(', '), node.x, node.y + 45);
            });
        }

        function regenerateGraph() {
            renderKnowledgeGraph();
        }

        function renderHistory() {
            const container = document.getElementById('history-list');

            if (rag.history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <div class="empty-state-text">No query history yet</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = rag.history.map(item => `
                <div class="history-item">
                    <div class="history-question">‚ùì ${item.question}</div>
                    <div class="history-answer">${item.answer}</div>
                    <div class="history-time">
                        ${new Date(item.timestamp).toLocaleString()}
                        <span class="badge badge-info">${item.sourceCount} sources</span>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all query history?')) {
                rag.clearHistory();
                renderHistory();
                updateStats();
            }
        }

        function exportKnowledgeBase() {
            const data = rag.exportData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `knowledge-base-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAllDocuments() {
            if (confirm('Are you sure you want to delete all documents? This cannot be undone.')) {
                rag.clearAll();
                updateStats();
                renderDocuments();
                document.getElementById('answer-container').innerHTML = '';
                document.getElementById('search-results').innerHTML = '';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            updateStats();
            renderDocuments();

            // Add some sample data if empty
            if (rag.documents.length === 0) {
                const sampleDocs = [
                    {
                        title: "Introduction to RAG",
                        content: "Retrieval-Augmented Generation (RAG) is a technique that combines information retrieval with text generation. It works by first retrieving relevant documents or passages from a knowledge base, then using those retrieved documents as context for generating responses. This approach helps reduce hallucinations and provides more accurate, grounded answers. RAG systems typically use vector embeddings and similarity search to find relevant information. The key components are: document chunking, embedding generation, similarity search, and context-aware generation."
                    },
                    {
                        title: "Machine Learning Basics",
                        content: "Machine learning is a subset of artificial intelligence that enables systems to learn and improve from experience without being explicitly programmed. There are three main types: supervised learning (learning from labeled data), unsupervised learning (finding patterns in unlabeled data), and reinforcement learning (learning through trial and error). Common algorithms include neural networks, decision trees, random forests, and support vector machines. Feature engineering and data preprocessing are crucial steps in building effective ML models."
                    },
                    {
                        title: "Natural Language Processing",
                        content: "Natural Language Processing (NLP) is a field of AI focused on enabling computers to understand, interpret, and generate human language. Key tasks include tokenization, part-of-speech tagging, named entity recognition, sentiment analysis, and machine translation. Modern NLP heavily relies on transformer architectures and pre-trained language models like BERT, GPT, and T5. TF-IDF and word embeddings are fundamental techniques for representing text as numerical vectors."
                    }
                ];

                sampleDocs.forEach(doc => {
                    rag.addDocument(doc.title, doc.content);
                });

                updateStats();
                renderDocuments();
            }
        });

        // Handle window resize for graph
        window.addEventListener('resize', () => {
            if (document.getElementById('graph-tab').classList.contains('active')) {
                renderKnowledgeGraph();
            }
        });
    </script>
</body>
</html>
