<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Particle Systems</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100vh; }
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
        }
        h2 { margin-bottom: 15px; color: #4ade80; }
        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 6px;
            background: #4ade80;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }
        button:hover { background: #22c55e; }
        .info {
            margin-top: 15px;
            font-size: 12px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="controls">
        <h2>Particle System</h2>
        <button onclick="particles.setMode('fireworks')">Fireworks</button>
        <button onclick="particles.setMode('trail')">Mouse Trail</button>
        <button onclick="particles.setMode('explosion')">Explosion</button>
        <button onclick="particles.setMode('starfield')">Starfield</button>
        <div class="info">
            Active: <span id="count">0</span> particles<br>
            FPS: <span id="fps">0</span>
        </div>
    </div>

    <script>
        class Particle {
            constructor(x, y, vx, vy, color, radius, lifetime) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.radius = radius;
                this.lifetime = lifetime;
                this.age = 0;
                this.gravity = 0.1;
            }

            update(deltaTime) {
                this.vx *= 0.99; // Air resistance
                this.vy += this.gravity;

                this.x += this.vx;
                this.y += this.vy;

                this.age += deltaTime;

                return this.age < this.lifetime;
            }

            draw(ctx) {
                const alpha = 1 - (this.age / this.lifetime);

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);

                // Gradient for glow effect
                const gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.radius
                );
                gradient.addColorStop(0, this.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba'));
                gradient.addColorStop(1, this.color.replace(')', ', 0)').replace('rgb', 'rgba'));

                ctx.fillStyle = gradient;
                ctx.fill();
            }
        }

        class ParticleSystem {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.mode = 'fireworks';
                this.mouseX = 0;
                this.mouseY = 0;
                this.lastTime = Date.now();
                this.fps = 0;
                this.frameCount = 0;
                this.lastFpsUpdate = Date.now();

                // Object pool for performance
                this.particlePool = [];
                this.poolSize = 2000;

                this.resize();
                this.setupEventListeners();
                this.animate();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            setupEventListeners() {
                window.addEventListener('resize', () => this.resize());

                this.canvas.addEventListener('mousemove', (e) => {
                    this.mouseX = e.clientX;
                    this.mouseY = e.clientY;

                    if (this.mode === 'trail') {
                        this.createTrail(e.clientX, e.clientY);
                    }
                });

                this.canvas.addEventListener('click', (e) => {
                    if (this.mode === 'explosion') {
                        this.createExplosion(e.clientX, e.clientY);
                    } else if (this.mode === 'fireworks') {
                        this.createFirework(e.clientX, e.clientY);
                    }
                });
            }

            setMode(mode) {
                this.mode = mode;
                this.particles = [];

                if (mode === 'starfield') {
                    this.createStarfield();
                } else if (mode === 'fireworks') {
                    this.createFirework(this.canvas.width / 2, this.canvas.height / 2);
                }
            }

            createParticle(x, y, vx, vy, color, radius, lifetime) {
                // Try to get from pool
                let particle = this.particlePool.pop();

                if (particle) {
                    Object.assign(particle, { x, y, vx, vy, color, radius, lifetime, age: 0 });
                } else {
                    particle = new Particle(x, y, vx, vy, color, radius, lifetime);
                }

                this.particles.push(particle);
                return particle;
            }

            recycleParticle(particle) {
                if (this.particlePool.length < this.poolSize) {
                    this.particlePool.push(particle);
                }
            }

            createFirework(x, y) {
                const colors = ['rgb(255, 100, 100)', 'rgb(100, 255, 100)', 'rgb(100, 100, 255)', 'rgb(255, 255, 100)'];
                const color = colors[Math.floor(Math.random() * colors.length)];

                for (let i = 0; i < 100; i++) {
                    const angle = (Math.PI * 2 * i) / 100;
                    const speed = Math.random() * 5 + 2;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;

                    this.createParticle(x, y, vx, vy, color, 3, 2000);
                }
            }

            createExplosion(x, y) {
                for (let i = 0; i < 50; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 8 + 2;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    const hue = Math.random() * 360;

                    this.createParticle(x, y, vx, vy, `hsl(${hue}, 100%, 50%)`, 4, 1500);
                }
            }

            createTrail(x, y) {
                const hue = (Date.now() / 10) % 360;
                this.createParticle(x, y, (Math.random() - 0.5) * 2, (Math.random() - 0.5) * 2,
                    `hsl(${hue}, 100%, 50%)`, 3, 1000);
            }

            createStarfield() {
                for (let i = 0; i < 200; i++) {
                    const x = Math.random() * this.canvas.width;
                    const y = Math.random() * this.canvas.height;
                    const vx = 0;
                    const vy = Math.random() * 2 + 1;

                    this.createParticle(x, y, vx, vy, 'rgb(255, 255, 255)', 2, Infinity);
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                const now = Date.now();
                const deltaTime = now - this.lastTime;
                this.lastTime = now;

                // Clear canvas with trail effect
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Update and draw particles
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    const alive = particle.update(deltaTime);

                    if (alive) {
                        particle.draw(this.ctx);

                        // Wrap starfield particles
                        if (this.mode === 'starfield' && particle.y > this.canvas.height) {
                            particle.y = 0;
                            particle.x = Math.random() * this.canvas.width;
                        }
                    } else {
                        this.recycleParticle(particle);
                        this.particles.splice(i, 1);
                    }
                }

                // Auto-create fireworks
                if (this.mode === 'fireworks' && Math.random() < 0.02) {
                    this.createFirework(
                        Math.random() * this.canvas.width,
                        Math.random() * this.canvas.height * 0.5
                    );
                }

                // Update UI
                this.updateFPS();
                document.getElementById('count').textContent = this.particles.length;
            }

            updateFPS() {
                this.frameCount++;
                const now = Date.now();

                if (now - this.lastFpsUpdate >= 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / (now - this.lastFpsUpdate));
                    document.getElementById('fps').textContent = this.fps;
                    this.frameCount = 0;
                    this.lastFpsUpdate = now;
                }
            }
        }

        const particles = new ParticleSystem();
    </script>
</body>
</html>
