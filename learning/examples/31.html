<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth 2.0 PKCE Flow for SPAs</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 { color: #333; margin-bottom: 30px; text-align: center; }
        .status {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover { background: #5568d3; }
        .code-display {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin: 15px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .step {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        .step-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .user-info {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .user-info h3 {
            color: #166534;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OAuth 2.0 PKCE Flow</h1>

        <div class="status" id="status">
            Ready to authenticate. Click "Login with OAuth" to begin.
        </div>

        <div id="loginSection">
            <button onclick="oauth.login()">Login with OAuth (PKCE)</button>

            <div class="step">
                <div class="step-title">Step 1: Generate Code Verifier</div>
                128-character random string for PKCE security
            </div>

            <div class="step">
                <div class="step-title">Step 2: Create Code Challenge</div>
                SHA-256 hash of verifier, base64url encoded
            </div>

            <div class="step">
                <div class="step-title">Step 3: Authorization Request</div>
                Redirect to OAuth provider with challenge
            </div>

            <div class="step">
                <div class="step-title">Step 4: Exchange Code</div>
                Trade authorization code + verifier for access token
            </div>
        </div>

        <div id="loggedInSection" style="display: none;">
            <div class="user-info">
                <h3>Logged In Successfully!</h3>
                <div id="userInfo"></div>
            </div>

            <div class="code-display" id="tokenDisplay"></div>

            <button onclick="oauth.logout()">Logout</button>
        </div>

        <div class="code-display" id="logDisplay"></div>
    </div>

    <script>
        class OAuth2PKCE {
            constructor() {
                this.clientId = 'demo_client_id';
                this.redirectUri = window.location.origin + window.location.pathname;
                this.authorizationEndpoint = 'https://oauth.example.com/authorize';
                this.tokenEndpoint = 'https://oauth.example.com/token';

                this.checkForCallback();
            }

            // Generate cryptographically random string
            generateRandomString(length) {
                const array = new Uint8Array(length);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // Generate code verifier (128 characters)
            generateCodeVerifier() {
                return this.generateRandomString(64); // 64 bytes = 128 hex chars
            }

            // Create SHA-256 hash and base64url encode
            async generateCodeChallenge(verifier) {
                const encoder = new TextEncoder();
                const data = encoder.encode(verifier);
                const hash = await crypto.subtle.digest('SHA-256', data);

                // Convert to base64url
                return this.base64urlEncode(hash);
            }

            base64urlEncode(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary)
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            }

            async login() {
                this.log('Starting OAuth 2.0 PKCE flow...');

                // Step 1: Generate code verifier
                const codeVerifier = this.generateCodeVerifier();
                this.log(`Generated code verifier: ${codeVerifier.substring(0, 32)}...`);

                // Store in sessionStorage for security
                sessionStorage.setItem('pkce_code_verifier', codeVerifier);

                // Step 2: Generate code challenge
                const codeChallenge = await this.generateCodeChallenge(codeVerifier);
                this.log(`Generated code challenge: ${codeChallenge.substring(0, 32)}...`);

                // Step 3: Generate state for CSRF protection
                const state = this.generateRandomString(16);
                sessionStorage.setItem('oauth_state', state);
                this.log(`Generated state: ${state}`);

                // Step 4: Build authorization URL
                const params = new URLSearchParams({
                    response_type: 'code',
                    client_id: this.clientId,
                    redirect_uri: this.redirectUri,
                    code_challenge: codeChallenge,
                    code_challenge_method: 'S256',
                    state: state,
                    scope: 'openid profile email'
                });

                const authUrl = `${this.authorizationEndpoint}?${params.toString()}`;

                this.log('Would redirect to: ' + authUrl.substring(0, 100) + '...');

                // In production, redirect to OAuth provider:
                // window.location.href = authUrl;

                // For demo, simulate the callback
                this.simulateCallback(state);
            }

            simulateCallback(state) {
                // Simulate OAuth provider callback
                setTimeout(() => {
                    const authCode = 'auth_code_' + this.generateRandomString(16);
                    this.log(`Simulated callback with authorization code: ${authCode}`);

                    // Call the callback handler
                    this.handleCallback(authCode, state);
                }, 1000);
            }

            async handleCallback(code, state) {
                // Verify state
                const storedState = sessionStorage.getItem('oauth_state');
                if (state !== storedState) {
                    this.showStatus('error', 'State mismatch - possible CSRF attack!');
                    return;
                }

                this.log('State verified successfully');

                // Get stored code verifier
                const codeVerifier = sessionStorage.getItem('pkce_code_verifier');

                if (!codeVerifier) {
                    this.showStatus('error', 'Code verifier not found');
                    return;
                }

                this.log('Retrieved code verifier from session');

                // Exchange authorization code for access token
                await this.exchangeCodeForToken(code, codeVerifier);
            }

            async exchangeCodeForToken(code, codeVerifier) {
                this.log('Exchanging authorization code for access token...');

                try {
                    // In production:
                    // const response = await fetch(this.tokenEndpoint, {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    //     body: new URLSearchParams({
                    //         grant_type: 'authorization_code',
                    //         code: code,
                    //         redirect_uri: this.redirectUri,
                    //         client_id: this.clientId,
                    //         code_verifier: codeVerifier
                    //     })
                    // });

                    // Simulate token response
                    await new Promise(resolve => setTimeout(resolve, 500));

                    const tokenResponse = {
                        access_token: 'access_token_' + this.generateRandomString(32),
                        token_type: 'Bearer',
                        expires_in: 3600,
                        refresh_token: 'refresh_token_' + this.generateRandomString(32),
                        id_token: 'id_token_' + this.generateRandomString(32)
                    };

                    this.log('Token exchange successful!');

                    // Store tokens
                    localStorage.setItem('access_token', tokenResponse.access_token);
                    localStorage.setItem('refresh_token', tokenResponse.refresh_token);

                    // Clear PKCE data from session
                    sessionStorage.removeItem('pkce_code_verifier');
                    sessionStorage.removeItem('oauth_state');

                    this.showLoggedIn(tokenResponse);

                } catch (error) {
                    this.showStatus('error', `Token exchange failed: ${error.message}`);
                }
            }

            checkForCallback() {
                // Check if we're returning from OAuth provider
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                const state = params.get('state');

                if (code && state) {
                    this.handleCallback(code, state);
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            showLoggedIn(tokenData) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('loggedInSection').style.display = 'block';

                document.getElementById('userInfo').innerHTML = `
                    <p><strong>Access Token:</strong> ${tokenData.access_token.substring(0, 40)}...</p>
                    <p><strong>Expires In:</strong> ${tokenData.expires_in} seconds</p>
                `;

                document.getElementById('tokenDisplay').textContent =
                    JSON.stringify(tokenData, null, 2);

                this.showStatus('success', 'Authentication successful! You are now logged in.');
            }

            logout() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');

                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('loggedInSection').style.display = 'none';

                this.log('Logged out successfully');
                this.showStatus('', 'Logged out. Click "Login with OAuth" to authenticate again.');
            }

            log(message) {
                const logDisplay = document.getElementById('logDisplay');
                const timestamp = new Date().toLocaleTimeString();
                logDisplay.textContent += `[${timestamp}] ${message}\n`;
                logDisplay.scrollTop = logDisplay.scrollHeight;
            }

            showStatus(type, message) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
            }
        }

        // Initialize OAuth client
        const oauth = new OAuth2PKCE();
    </script>
</body>
</html>
