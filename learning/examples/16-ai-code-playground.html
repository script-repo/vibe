<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Playground</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #15151f;
            --bg-tertiary: #1f1f2e;
            --accent-1: #667eea;
            --accent-2: #764ba2;
            --accent-3: #f093fb;
            --accent-4: #4facfe;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-primary);
            backdrop-filter: blur(10px);
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-3), var(--accent-4));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            background: var(--glass-border);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border: none;
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .btn-success {
            background: var(--success);
            border: none;
            color: white;
        }

        .btn-ai {
            background: linear-gradient(135deg, #f093fb, #4facfe);
            border: none;
            color: white;
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
        }

        .ai-feature {
            padding: 0.75rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-feature:hover {
            background: var(--glass-border);
            transform: translateX(5px);
        }

        .ai-feature-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .ai-feature-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Editor Area */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            padding: 0.5rem 0.5rem 0;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            margin-right: 0.25rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab.active {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--accent-1);
        }

        .tab-close {
            margin-left: 0.5rem;
            color: var(--text-secondary);
            font-weight: bold;
        }

        .tab-close:hover {
            color: var(--error);
        }

        .tab-add {
            padding: 0.5rem 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        /* Editor */
        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .editor {
            width: 100%;
            height: 100%;
            padding: 1rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            outline: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            tab-size: 4;
        }

        .code-display {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            pointer-events: none;
            overflow: auto;
            color: transparent;
            caret-color: var(--text-primary);
        }

        /* Syntax Highlighting */
        .keyword { color: #c678dd; }
        .string { color: #98c379; }
        .comment { color: #5c6370; font-style: italic; }
        .number { color: #d19a66; }
        .function { color: #61afef; }
        .operator { color: #56b6c2; }
        .type { color: #e5c07b; }
        .property { color: #e06c75; }

        /* Console */
        .console-container {
            height: 200px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .console-header {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-output {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .console-line {
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
        }

        .console-log { color: var(--text-primary); }
        .console-error { color: var(--error); }
        .console-warn { color: var(--warning); }
        .console-info { color: var(--accent-4); }
        .console-success { color: var(--success); }

        /* Output Frame */
        .output-container {
            flex: 1;
            display: none;
            flex-direction: column;
            background: white;
            border-left: 1px solid var(--border-color);
        }

        .output-container.active {
            display: flex;
        }

        .output-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-3), var(--accent-4));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* Loading */
        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--glass-border);
            border-top-color: var(--accent-1);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Language Badge */
        .language-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }

        /* Split View */
        .split-view {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Saved Snippets */
        .snippet-item {
            padding: 0.75rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .snippet-item:hover {
            background: var(--glass-border);
            transform: translateX(5px);
        }

        .snippet-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .snippet-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .snippet-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* AI Chat */
        .ai-chat {
            display: none;
            flex-direction: column;
            height: 100%;
            background: var(--bg-secondary);
        }

        .ai-chat.active {
            display: flex;
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .ai-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .ai-message.user {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            margin-left: 2rem;
        }

        .ai-message.assistant {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid var(--accent-1);
            margin-right: 2rem;
        }

        .ai-input-container {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }

        .ai-input {
            display: flex;
            gap: 0.5rem;
        }

        .ai-input textarea {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            resize: none;
            font-family: inherit;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 0.5rem;
        }

        .language-select {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>AI Code Playground</h1>
            <div class="header-controls">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
                <button class="btn" onclick="showSettings()">Settings</button>
                <button class="btn" onclick="showSavedSnippets()">Saved</button>
                <button class="btn btn-success" onclick="runCode()">Run Code</button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>AI Features</h3>
                    <div class="ai-feature" onclick="showAIPrompt('complete')">
                        <div class="ai-feature-title">Code Completion</div>
                        <div class="ai-feature-desc">Get intelligent code suggestions</div>
                    </div>
                    <div class="ai-feature" onclick="showAIPrompt('explain')">
                        <div class="ai-feature-title">Explain Code</div>
                        <div class="ai-feature-desc">Understand what your code does</div>
                    </div>
                    <div class="ai-feature" onclick="showAIPrompt('debug')">
                        <div class="ai-feature-title">Debug Assistant</div>
                        <div class="ai-feature-desc">Find and fix bugs</div>
                    </div>
                    <div class="ai-feature" onclick="showAIPrompt('optimize')">
                        <div class="ai-feature-title">Optimize Code</div>
                        <div class="ai-feature-desc">Improve performance & readability</div>
                    </div>
                    <div class="ai-feature" onclick="showAIPrompt('generate')">
                        <div class="ai-feature-title">Generate Code</div>
                        <div class="ai-feature-desc">Create code from description</div>
                    </div>
                    <div class="ai-feature" onclick="showAIPrompt('refactor')">
                        <div class="ai-feature-title">Refactor</div>
                        <div class="ai-feature-desc">Restructure code</div>
                    </div>
                    <div class="ai-feature" onclick="showAIPrompt('test')">
                        <div class="ai-feature-title">Generate Tests</div>
                        <div class="ai-feature-desc">Create unit tests</div>
                    </div>
                    <div class="ai-feature" onclick="showAIPrompt('document')">
                        <div class="ai-feature-title">Document Code</div>
                        <div class="ai-feature-desc">Add comments & docs</div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Actions</h3>
                    <div class="ai-feature" onclick="saveSnippet()">
                        <div class="ai-feature-title">Save Snippet</div>
                        <div class="ai-feature-desc">Save current code</div>
                    </div>
                    <div class="ai-feature" onclick="exportCode()">
                        <div class="ai-feature-title">Export Code</div>
                        <div class="ai-feature-desc">Download files</div>
                    </div>
                    <div class="ai-feature" onclick="clearConsole()">
                        <div class="ai-feature-title">Clear Console</div>
                        <div class="ai-feature-desc">Reset output</div>
                    </div>
                </div>
            </div>

            <!-- Editor Area -->
            <div class="split-view">
                <div class="editor-area">
                    <!-- Toolbar -->
                    <div class="toolbar">
                        <select class="language-select" onchange="changeLanguage(this.value)">
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                        </select>
                        <div class="toolbar-divider"></div>
                        <button class="btn btn-small" onclick="formatCode()">Format</button>
                        <button class="btn btn-small" onclick="clearEditor()">Clear</button>
                    </div>

                    <!-- Tabs -->
                    <div class="tabs" id="tabs">
                        <div class="tab active" data-file="main.js" onclick="switchTab('main.js')">
                            <span>main.js</span>
                            <span class="tab-close" onclick="closeTab(event, 'main.js')">×</span>
                        </div>
                        <button class="tab-add" onclick="addNewTab()">+ New</button>
                    </div>

                    <!-- Editor -->
                    <div class="editor-container">
                        <textarea class="editor" id="editor" spellcheck="false" oninput="updateCode()" onscroll="syncScroll()" onkeydown="handleTab(event)">// Welcome to AI Code Playground!
// Try writing some code and use the AI features on the left

function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

console.log("Fibonacci sequence:");
for (let i = 0; i < 10; i++) {
    console.log(`F(${i}) = ${fibonacci(i)}`);
}</textarea>
                    </div>

                    <!-- Console -->
                    <div class="console-container">
                        <div class="console-header">
                            <div>Console Output</div>
                            <button class="btn btn-small" onclick="clearConsole()">Clear</button>
                        </div>
                        <div class="console-output" id="console"></div>
                    </div>
                </div>

                <!-- Output Frame -->
                <div class="output-container" id="outputContainer">
                    <div class="console-header">
                        <div>Preview</div>
                        <button class="btn btn-small" onclick="toggleOutput()">Close</button>
                    </div>
                    <iframe class="output-frame" id="outputFrame"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
            </div>
            <div class="form-group">
                <label>AI Provider</label>
                <select id="aiProvider">
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                </select>
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="apiKey" placeholder="Enter your API key">
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                    Your API key is stored locally and never sent anywhere except the AI provider.
                </small>
            </div>
            <div class="form-group">
                <label>Model</label>
                <input type="text" id="aiModel" placeholder="e.g., gpt-4, claude-3-sonnet">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- AI Prompt Modal -->
    <div class="modal" id="aiPromptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="aiPromptTitle">AI Assistant</h2>
            </div>
            <div class="form-group">
                <label id="aiPromptLabel">Enter your request</label>
                <textarea id="aiPromptInput" placeholder="Describe what you want..."></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="aiUseSelection" checked>
                    Use selected code (or current file)
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('aiPromptModal')">Cancel</button>
                <button class="btn btn-ai" onclick="processAIRequest()">Submit</button>
            </div>
        </div>
    </div>

    <!-- Save Snippet Modal -->
    <div class="modal" id="saveSnippetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save Code Snippet</h2>
            </div>
            <div class="form-group">
                <label>Snippet Name</label>
                <input type="text" id="snippetName" placeholder="My Awesome Code">
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <textarea id="snippetDescription" placeholder="What does this code do?"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('saveSnippetModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveSnippetConfirm()">Save</button>
            </div>
        </div>
    </div>

    <!-- Saved Snippets Modal -->
    <div class="modal" id="savedSnippetsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Saved Snippets</h2>
            </div>
            <div id="snippetsList"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('savedSnippetsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- AI Response Modal -->
    <div class="modal" id="aiResponseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>AI Response</h2>
            </div>
            <div id="aiResponseContent" style="max-height: 400px; overflow-y: auto; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; font-family: 'Consolas', monospace; white-space: pre-wrap;"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('aiResponseModal')">Close</button>
                <button class="btn btn-primary" onclick="applyAIResponse()">Apply to Editor</button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        const state = {
            currentFile: 'main.js',
            files: {
                'main.js': {
                    content: `// Welcome to AI Code Playground!
// Try writing some code and use the AI features on the left

function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

console.log("Fibonacci sequence:");
for (let i = 0; i < 10; i++) {
    console.log(\`F(\${i}) = \${fibonacci(i)}\`);
}`,
                    language: 'javascript'
                }
            },
            currentAIAction: null,
            lastAIResponse: null,
            settings: {
                provider: 'openai',
                apiKey: '',
                model: 'gpt-4'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            updateCode();
            loadSavedSnippets();
        });

        // Settings
        function loadSettings() {
            const saved = localStorage.getItem('aiCodePlaygroundSettings');
            if (saved) {
                state.settings = JSON.parse(saved);
                document.getElementById('aiProvider').value = state.settings.provider;
                document.getElementById('apiKey').value = state.settings.apiKey;
                document.getElementById('aiModel').value = state.settings.model;
            }
        }

        function saveSettings() {
            state.settings = {
                provider: document.getElementById('aiProvider').value,
                apiKey: document.getElementById('apiKey').value,
                model: document.getElementById('aiModel').value
            };
            localStorage.setItem('aiCodePlaygroundSettings', JSON.stringify(state.settings));
            closeModal('settingsModal');
            logConsole('Settings saved successfully', 'success');
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        // Tab Management
        function switchTab(filename) {
            state.currentFile = filename;
            const editor = document.getElementById('editor');
            editor.value = state.files[filename].content;

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.file === filename) {
                    tab.classList.add('active');
                }
            });

            updateCode();
        }

        function closeTab(event, filename) {
            event.stopPropagation();
            if (Object.keys(state.files).length === 1) {
                logConsole('Cannot close the last tab', 'error');
                return;
            }

            delete state.files[filename];

            // Switch to another tab
            const remainingFiles = Object.keys(state.files);
            state.currentFile = remainingFiles[0];

            renderTabs();
            switchTab(state.currentFile);
        }

        function addNewTab() {
            const name = prompt('Enter file name (e.g., script.js, style.css):');
            if (!name) return;

            const ext = name.split('.').pop().toLowerCase();
            let language = 'javascript';
            if (ext === 'py') language = 'python';
            else if (ext === 'html') language = 'html';
            else if (ext === 'css') language = 'css';

            state.files[name] = {
                content: '',
                language: language
            };

            renderTabs();
            switchTab(name);
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';

            Object.keys(state.files).forEach(filename => {
                const tab = document.createElement('div');
                tab.className = 'tab' + (filename === state.currentFile ? ' active' : '');
                tab.dataset.file = filename;
                tab.onclick = () => switchTab(filename);
                tab.innerHTML = `
                    <span>${filename}</span>
                    <span class="tab-close" onclick="closeTab(event, '${filename}')">×</span>
                `;
                tabsContainer.appendChild(tab);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'tab-add';
            addBtn.textContent = '+ New';
            addBtn.onclick = addNewTab;
            tabsContainer.appendChild(addBtn);
        }

        // Editor Functions
        function updateCode() {
            const editor = document.getElementById('editor');
            state.files[state.currentFile].content = editor.value;
        }

        function handleTab(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                const value = e.target.value;
                e.target.value = value.substring(0, start) + '    ' + value.substring(end);
                e.target.selectionStart = e.target.selectionEnd = start + 4;
                updateCode();
            }
        }

        function changeLanguage(lang) {
            state.files[state.currentFile].language = lang;
            updateCode();
        }

        function formatCode() {
            const editor = document.getElementById('editor');
            let code = editor.value;

            // Simple formatting
            const lines = code.split('\n');
            let indentLevel = 0;
            const formatted = lines.map(line => {
                const trimmed = line.trim();
                if (!trimmed) return '';

                if (trimmed.startsWith('}') || trimmed.startsWith(']') || trimmed.startsWith(')')) {
                    indentLevel = Math.max(0, indentLevel - 1);
                }

                const indented = '    '.repeat(indentLevel) + trimmed;

                if (trimmed.endsWith('{') || trimmed.endsWith('[') || trimmed.endsWith('(')) {
                    indentLevel++;
                }

                return indented;
            }).join('\n');

            editor.value = formatted;
            updateCode();
            logConsole('Code formatted', 'success');
        }

        function clearEditor() {
            if (confirm('Clear current file?')) {
                document.getElementById('editor').value = '';
                updateCode();
            }
        }

        // Code Execution
        function runCode() {
            clearConsole();
            const file = state.files[state.currentFile];
            const code = file.content;
            const language = file.language;

            logConsole(`Running ${language} code...`, 'info');

            if (language === 'javascript') {
                runJavaScript(code);
            } else if (language === 'html' || language === 'css') {
                runHTML(code, language);
            } else if (language === 'python') {
                logConsole('Python execution requires a backend server. Showing code instead.', 'warn');
                logConsole(code, 'log');
            }
        }

        function runJavaScript(code) {
            try {
                // Create sandbox
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                const iframeWindow = iframe.contentWindow;

                // Override console methods
                const consoleOverrides = {
                    log: (...args) => logConsole(args.join(' '), 'log'),
                    error: (...args) => logConsole(args.join(' '), 'error'),
                    warn: (...args) => logConsole(args.join(' '), 'warn'),
                    info: (...args) => logConsole(args.join(' '), 'info')
                };

                Object.assign(iframeWindow.console, consoleOverrides);

                // Execute code
                iframeWindow.eval(code);

                // Clean up
                setTimeout(() => document.body.removeChild(iframe), 100);

                logConsole('Execution completed', 'success');
            } catch (error) {
                logConsole(`Error: ${error.message}`, 'error');
            }
        }

        function runHTML(code, language) {
            const outputContainer = document.getElementById('outputContainer');
            const outputFrame = document.getElementById('outputFrame');

            let html = '';
            if (language === 'html') {
                html = code;
            } else if (language === 'css') {
                html = `<style>${code}</style><div style="padding: 20px;">CSS Preview</div>`;
            }

            outputFrame.srcdoc = html;
            outputContainer.classList.add('active');
            logConsole('Preview updated', 'success');
        }

        function toggleOutput() {
            document.getElementById('outputContainer').classList.toggle('active');
        }

        // Console
        function logConsole(message, type = 'log') {
            const consoleOutput = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        // AI Features
        function showAIPrompt(action) {
            if (!state.settings.apiKey) {
                alert('Please configure your API key in Settings first.');
                showSettings();
                return;
            }

            state.currentAIAction = action;
            const modal = document.getElementById('aiPromptModal');
            const title = document.getElementById('aiPromptTitle');
            const label = document.getElementById('aiPromptLabel');
            const input = document.getElementById('aiPromptInput');

            const prompts = {
                complete: {
                    title: 'Code Completion',
                    label: 'Describe what you want to add:',
                    placeholder: 'Add error handling, implement feature X...'
                },
                explain: {
                    title: 'Explain Code',
                    label: 'What do you want explained?',
                    placeholder: 'Explain the selected code...'
                },
                debug: {
                    title: 'Debug Assistant',
                    label: 'Describe the issue:',
                    placeholder: 'Getting error X, expected Y but got Z...'
                },
                optimize: {
                    title: 'Optimize Code',
                    label: 'What to optimize?',
                    placeholder: 'Performance, readability, memory usage...'
                },
                generate: {
                    title: 'Generate Code',
                    label: 'Describe what to generate:',
                    placeholder: 'Create a function that...'
                },
                refactor: {
                    title: 'Refactor Code',
                    label: 'How to refactor?',
                    placeholder: 'Extract functions, rename variables...'
                },
                test: {
                    title: 'Generate Tests',
                    label: 'Test requirements:',
                    placeholder: 'Create unit tests for...'
                },
                document: {
                    title: 'Document Code',
                    label: 'Documentation style:',
                    placeholder: 'JSDoc, inline comments...'
                }
            };

            const config = prompts[action];
            title.textContent = config.title;
            label.textContent = config.label;
            input.placeholder = config.placeholder;
            input.value = '';

            modal.classList.add('active');
        }

        async function processAIRequest() {
            const action = state.currentAIAction;
            const userPrompt = document.getElementById('aiPromptInput').value;
            const useCode = document.getElementById('aiUseSelection').checked;

            closeModal('aiPromptModal');

            const editor = document.getElementById('editor');
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            const code = useCode ? (selectedText || state.files[state.currentFile].content) : '';

            const systemPrompts = {
                complete: 'You are a code completion assistant. Complete or add to the provided code based on the user\'s request. Return only the code.',
                explain: 'You are a code explanation assistant. Explain the provided code clearly and concisely.',
                debug: 'You are a debugging assistant. Analyze the code and help fix the issue described.',
                optimize: 'You are a code optimization assistant. Suggest improvements for the provided code.',
                generate: 'You are a code generation assistant. Generate code based on the description. Return only the code.',
                refactor: 'You are a refactoring assistant. Refactor the code based on the requirements. Return the refactored code.',
                test: 'You are a test generation assistant. Generate unit tests for the provided code.',
                document: 'You are a documentation assistant. Add appropriate documentation to the code.'
            };

            const prompt = `${systemPrompts[action]}

User Request: ${userPrompt}

${code ? `Code:\n\`\`\`\n${code}\n\`\`\`` : ''}

Language: ${state.files[state.currentFile].language}`;

            await callAI(prompt);
        }

        async function callAI(prompt) {
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                let response;

                if (state.settings.provider === 'openai') {
                    response = await callOpenAI(prompt);
                } else {
                    response = await callAnthropic(prompt);
                }

                state.lastAIResponse = response;
                showAIResponse(response);
                logConsole('AI request completed', 'success');
            } catch (error) {
                logConsole(`AI Error: ${error.message}`, 'error');
                alert(`Error: ${error.message}`);
            } finally {
                loading.classList.remove('active');
            }
        }

        async function callOpenAI(prompt) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.settings.apiKey}`
                },
                body: JSON.stringify({
                    model: state.settings.model || 'gpt-4',
                    messages: [
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callAnthropic(prompt) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.settings.apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: state.settings.model || 'claude-3-sonnet-20240229',
                    max_tokens: 2000,
                    messages: [
                        { role: 'user', content: prompt }
                    ]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.content[0].text;
        }

        function showAIResponse(response) {
            const modal = document.getElementById('aiResponseModal');
            const content = document.getElementById('aiResponseContent');
            content.textContent = response;
            modal.classList.add('active');
        }

        function applyAIResponse() {
            if (state.lastAIResponse) {
                // Extract code from response if wrapped in code blocks
                let code = state.lastAIResponse;
                const codeMatch = code.match(/```(?:\w+)?\n([\s\S]*?)```/);
                if (codeMatch) {
                    code = codeMatch[1];
                }

                // Apply to editor
                const editor = document.getElementById('editor');
                const start = editor.selectionStart;
                const end = editor.selectionEnd;

                if (start !== end) {
                    // Replace selection
                    const value = editor.value;
                    editor.value = value.substring(0, start) + code + value.substring(end);
                } else {
                    // Append or replace all
                    if (confirm('Replace entire file or append?')) {
                        editor.value = code;
                    } else {
                        editor.value += '\n\n' + code;
                    }
                }

                updateCode();
                closeModal('aiResponseModal');
                logConsole('AI response applied to editor', 'success');
            }
        }

        // Snippets
        function saveSnippet() {
            document.getElementById('saveSnippetModal').classList.add('active');
        }

        function saveSnippetConfirm() {
            const name = document.getElementById('snippetName').value;
            const description = document.getElementById('snippetDescription').value;

            if (!name) {
                alert('Please enter a name');
                return;
            }

            const snippets = JSON.parse(localStorage.getItem('codeSnippets') || '[]');

            snippets.push({
                id: Date.now(),
                name: name,
                description: description,
                code: state.files[state.currentFile].content,
                language: state.files[state.currentFile].language,
                filename: state.currentFile,
                date: new Date().toISOString()
            });

            localStorage.setItem('codeSnippets', JSON.stringify(snippets));
            closeModal('saveSnippetModal');
            logConsole('Snippet saved', 'success');
        }

        function showSavedSnippets() {
            loadSavedSnippets();
            document.getElementById('savedSnippetsModal').classList.add('active');
        }

        function loadSavedSnippets() {
            const snippets = JSON.parse(localStorage.getItem('codeSnippets') || '[]');
            const list = document.getElementById('snippetsList');

            if (snippets.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No saved snippets yet</p>';
                return;
            }

            list.innerHTML = snippets.reverse().map(snippet => `
                <div class="snippet-item">
                    <div class="snippet-name">${snippet.name}</div>
                    <div class="snippet-meta">
                        <span class="language-badge">${snippet.language}</span>
                        ${snippet.description ? `<div style="margin-top: 0.5rem;">${snippet.description}</div>` : ''}
                        <div style="margin-top: 0.5rem; font-size: 0.7rem;">
                            ${new Date(snippet.date).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="snippet-actions">
                        <button class="btn btn-small btn-primary" onclick="loadSnippet(${snippet.id})">Load</button>
                        <button class="btn btn-small" onclick="deleteSnippet(${snippet.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function loadSnippet(id) {
            const snippets = JSON.parse(localStorage.getItem('codeSnippets') || '[]');
            const snippet = snippets.find(s => s.id === id);

            if (snippet) {
                state.files[snippet.filename] = {
                    content: snippet.code,
                    language: snippet.language
                };

                renderTabs();
                switchTab(snippet.filename);
                closeModal('savedSnippetsModal');
                logConsole('Snippet loaded', 'success');
            }
        }

        function deleteSnippet(id) {
            if (confirm('Delete this snippet?')) {
                let snippets = JSON.parse(localStorage.getItem('codeSnippets') || '[]');
                snippets = snippets.filter(s => s.id !== id);
                localStorage.setItem('codeSnippets', JSON.stringify(snippets));
                loadSavedSnippets();
                logConsole('Snippet deleted', 'success');
            }
        }

        // Export
        function exportCode() {
            const files = Object.entries(state.files);

            if (files.length === 1) {
                // Export single file
                const [filename, file] = files[0];
                downloadFile(filename, file.content);
            } else {
                // Export as zip (simple multiple downloads)
                files.forEach(([filename, file]) => {
                    downloadFile(filename, file.content);
                });
            }

            logConsole('Code exported', 'success');
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Modal Management
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Click outside to close modal
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveSnippet();
            }

            // Ctrl/Cmd + Enter to run
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }

            // Ctrl/Cmd + K for AI
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                showAIPrompt('complete');
            }
        });
    </script>
</body>
</html>
